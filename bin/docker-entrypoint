#!/bin/bash -e

SECRET_FILE=/rails/tmp/secret_key_base

# Default is production environment
if [ -z "$RAILS_ENV" ]; then
  export RAILS_ENV=production
fi

# Generate and persist SECRET_KEY_BASE if missing
if [ -z "$SECRET_KEY_BASE" ]; then
  if [ ! -f "$SECRET_FILE" ]; then
    echo "Generating SECRET_KEY_BASE..."
    ./bin/rails secret > "$SECRET_FILE"
  fi
  export SECRET_KEY_BASE=$(cat "$SECRET_FILE")
fi

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "$@"