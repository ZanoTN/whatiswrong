services:
  web:
    image: zanotn/whatiswrong:latest
    depends_on:
      - db
    ports:
      - "8085:3000"
    environment:
      DB_ADAPTER: postgresql
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: whatiswrong_production
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
    volumes:
      - secrets:/rails/secrets
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    restart: unless-stopped

  db:
    image: postgres
    container_name: whatiswrong_db
    volumes:
      - postgres_data:/var/lib/postgresql
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      POSTGRES_DB: whatiswrong_production
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    restart: unless-stopped

  # Watchtower service to auto-update the app container when a new image is available
  watchtower:
    image: nickfedor/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 23 * * *
      - WATCHTOWER_LABEL_ENABLE=true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  postgres_data:
  secrets:
